<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html">

    <body>
        <ui:composition template="./../TemplateSitio.xhtml">

            <ui:define name="content">
                <div class="container-fluid py-4">
                    <h1 class="text-primary mb-4">Reportes de Caracterizaci√≥n</h1>

                    <!-- üìä M√©tricas r√°pidas -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-white bg-info shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Total Estudiantes</h5>
                                    <p class="card-text display-6">
                                        #{reporteBean.totalEstudiantes}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card text-white bg-success shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Total Caracterizaciones</h5>
                                    <p class="card-text display-6">
                                        #{reporteBean.totalCaracterizaciones}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üìã Tabla diagn√≥sticos -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            Cantidad por Diagn√≥stico
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Diagn√≥stico</th>
                                        <th class="text-end">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ui:repeat var="d" value="#{reporteBean.diagnosticos}">
                                        <tr>
                                            <td>#{d.diagnostico}</td>
                                            <td class="text-end">#{d.cantidad}</td>
                                        </tr>
                                    </ui:repeat>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- üìä Gr√°fica -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            Gr√°fica Diagn√≥sticos
                        </div>
                        <div class="card-body">
                            <canvas id="diagnosticosChart"></canvas>
                        </div>
                    </div>

                    <!-- üìÇ Botones de exportaci√≥n -->
                    <div class="mt-3 text-end">
                        <h:form>
                            <h:commandLink value="Exportar a PDF"
                                           action="#{reportePdfBean.generarPdf()}"
                                           styleClass="btn btn-danger me-2" />
                        </h:form>
                    </div>
                </div>

                <!-- ‚úÖ Librer√≠a Chart.js primero -->
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

                <!-- üìå Script din√°mico con datos desde el bean -->
                <h:outputScript>
                    var ctx = document.getElementById('diagnosticosChart').getContext('2d');
                    var chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                    labels: [
                    'Total Estudiantes',
                    'Total Caracterizaciones',
                    <ui:repeat var="d" value="#{reporteBean.diagnosticos}" varStatus="st">
                        '#{d.diagnostico}'#{st.last ? '' : ','}
                    </ui:repeat>
                    ],
                    datasets: [{
                    label: 'Cantidad',
                    data: [
                    #{reporteBean.totalEstudiantes},
                    #{reporteBean.totalCaracterizaciones},
                    <ui:repeat var="d" value="#{reporteBean.diagnosticos}" varStatus="st">
                        #{d.cantidad}#{st.last ? '' : ','}
                    </ui:repeat>
                    ],
                    backgroundColor: [
                    '#007bff', // azul para estudiantes
                    '#28a745', // verde para caracterizaciones
                    <ui:repeat var="d" value="#{reporteBean.diagnosticos}" varStatus="st">
                        '#ffc107'#{st.last ? '' : ','} <!-- amarillo para diagn√≥sticos -->
                    </ui:repeat>
                    ]
                    }]
                    },
                    options: {
                    responsive: true,
                    plugins: {
                    legend: { display: false }
                    }
                    }
                    });
                </h:outputScript>
            </ui:define>
        </ui:composition>
    </body>
</html>