<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

    <body>

        <ui:composition template="./../TemplateSitio.xhtml">

            <ui:define name="content">
                
                <h:form id="formMsgs">
                    <p:growl id="growl" showDetail="true" life="5000" />
                </h:form>

                <div class="container-fluid mt-4">
                    
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="text-primary fw-bold"><i class="fas fa-cogs me-2"></i>Panel de Administración</h2>
                    </div>

                    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button">Gestión de Usuarios</button></li>
                        <li class="nav-item"><button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button">Auditoría</button></li>
                        <li class="nav-item"><button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button">Reportes</button></li>
                    </ul>

                    <div class="tab-content bg-white p-4 border border-top-0 rounded-bottom shadow-sm">
                        
                        <div class="tab-pane fade show active" id="usuarios">
                            <h:form id="formUsuarios">
                                <div class="mb-3 text-end">
                                    <h:commandButton value="+ Nuevo Usuario" action="#{adminController.prepararCreacion}" styleClass="btn btn-success">
                                        <f:ajax render=":modalUsuarioContent" onevent="abrirModal" />
                                    </h:commandButton>
                                </div>

                                <p:dataTable value="#{adminController.listaUsuarios}" var="u" paginator="true" rows="10" rowHover="true">
                                    
                                    <p:column headerText="Documento" sortBy="#{u.numeroDocumento}" filterBy="#{u.numeroDocumento}">
                                        <h:outputText value="#{u.numeroDocumento}" />
                                    </p:column>

                                    <p:column headerText="Nombre" sortBy="#{u.primerNombre}" filterBy="#{u.primerNombre}">
                                        <h:outputText value="#{u.primerNombre} #{u.primerApellido}" />
                                    </p:column>

                                    <p:column headerText="Rol" sortBy="#{u.rolIdRol.nombreRol}">
                                        <span class="badge bg-info text-dark">#{u.rolIdRol.nombreRol}</span>
                                    </p:column>

                                    <p:column headerText="Correo">
                                        <h:outputText value="#{u.correoUsuario}" />
                                    </p:column>

                                    <p:column headerText="Estado" styleClass="text-center">
                                        <h:panelGroup rendered="#{u.estatus eq 'ACTIVO'}">
                                            <span class="badge bg-success">ACTIVO</span>
                                        </h:panelGroup>
                                        <h:panelGroup rendered="#{u.estatus ne 'ACTIVO'}">
                                            <span class="badge bg-danger">#{u.estatus}</span>
                                        </h:panelGroup>
                                    </p:column>

                                    <p:column headerText="Acciones" styleClass="text-center" width="180">
                                        <div class="btn-group btn-group-sm">
                                            <h:commandLink action="#{adminController.prepararEdicion(u)}" styleClass="btn btn-outline-primary" title="Editar">
                                                <i class="fas fa-edit"></i>
                                                <f:ajax render=":modalUsuarioContent" onevent="abrirModal" />
                                            </h:commandLink>

                                            <h:commandLink action="#{adminController.alternarEstado(u)}" 
                                                           styleClass="btn #{u.estatus eq 'ACTIVO' ? 'btn-outline-warning' : 'btn-outline-success'}" 
                                                           title="Cambiar Estado">
                                                <i class="fas #{u.estatus eq 'ACTIVO' ? 'fa-ban' : 'fa-check'}"></i>
                                                <f:ajax render="@form :formMsgs:growl" />
                                            </h:commandLink>

                                            <h:commandLink action="#{adminController.restablecerPassword(u)}" styleClass="btn btn-outline-dark" 
                                                           title="Restablecer Clave" onclick="return confirm('¿Restablecer clave?');">
                                                <i class="fas fa-key"></i>
                                                <f:ajax render=":formMsgs:growl" />
                                            </h:commandLink>
                                            
                                            <h:commandLink action="#{adminController.eliminarUsuario(u)}" styleClass="btn btn-outline-danger" 
                                                           title="Eliminar" onclick="return confirm('¿Eliminar usuario?');">
                                                <i class="fas fa-trash"></i>
                                                <f:ajax render="@form :formMsgs:growl" />
                                            </h:commandLink>
                                        </div>
                                    </p:column>
                                </p:dataTable>
                            </h:form>
                        </div>

                        <div class="tab-pane fade" id="logs">
                            <p:dataTable value="#{adminController.listaLogs}" var="log" paginator="true" rows="15" styleClass="table-sm">
                                <p:column headerText="Fecha" sortBy="#{log.changedAt}">
                                    <h:outputText value="#{log.changedAt}"><f:convertDateTime pattern="dd/MM/yyyy HH:mm"/></h:outputText>
                                </p:column>
                                <p:column headerText="Usuario" sortBy="#{log.changedBy}">#{log.changedBy}</p:column>
                                <p:column headerText="Acción">#{log.operationType}</p:column>
                                <p:column headerText="Detalle">#{log.tableName} (ID: #{log.recordId})</p:column>
                            </p:dataTable>
                        </div>

                        <div class="tab-pane fade" id="reportes">
                            <h:form>
                                <div class="row g-4">
                                    <div class="col-md-4">
                                        <div class="card h-100 text-center p-4 border-0 shadow-sm bg-light">
                                            <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                            <h5>Usuarios PDF</h5>
                                            <h:commandButton value="Descargar" action="#{adminController.descargarReporte('PDF')}" styleClass="btn btn-danger btn-sm" />
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card h-100 text-center p-4 border-0 shadow-sm bg-light">
                                            <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                                            <h5>Estadísticas Excel</h5>
                                            <h:commandButton value="Descargar" action="#{adminController.descargarReporte('Excel')}" styleClass="btn btn-success btn-sm" />
                                        </div>
                                    </div>
                                </div>
                            </h:form>
                        </div>
                    </div>
                </div>

                <h:panelGroup id="modalUsuarioContent">
                    <div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <h:form id="formModal">
                                    <div class="modal-header bg-primary text-white">
                                        <h5 class="modal-title">#{adminController.accionTitulo}</h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        
                                        <div class="mb-3">
                                            <label class="form-label">Tipo Documento</label>
                                            <h:selectOneMenu value="#{adminController.usuarioSeleccionado.tipoDocumentoIdTipoDocumento}" 
                                                             styleClass="form-select" converter="#{tipoDocumentoConverter}">
                                                <f:selectItems value="#{adminController.listaTiposDoc}" var="td" 
                                                               itemLabel="#{td.nombreTipoDocumento}" itemValue="#{td}"/>
                                            </h:selectOneMenu>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Número Documento</label>
                                            <h:inputText value="#{adminController.usuarioSeleccionado.numeroDocumento}" styleClass="form-control" required="true"/>
                                        </div>

                                        <div class="row">
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Nombres</label>
                                                <h:inputText value="#{adminController.usuarioSeleccionado.primerNombre}" styleClass="form-control" required="true"/>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <label class="form-label">Apellidos</label>
                                                <h:inputText value="#{adminController.usuarioSeleccionado.primerApellido}" styleClass="form-control" required="true"/>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Correo</label>
                                            <h:inputText value="#{adminController.usuarioSeleccionado.correoUsuario}" styleClass="form-control" required="true"/>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Rol</label>
                                            <h:selectOneMenu value="#{adminController.usuarioSeleccionado.rolIdRol}" 
                                                             styleClass="form-select" converter="#{rolConverter}">
                                                <f:selectItems value="#{adminController.listaRoles}" var="r" 
                                                               itemLabel="#{r.nombreRol}" itemValue="#{r}"/>
                                            </h:selectOneMenu>
                                        </div>

                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                        <h:commandButton value="Guardar" action="#{adminController.guardarUsuario}" styleClass="btn btn-primary">
                                            <f:ajax execute="@form" render=":formUsuarios :formMsgs:growl" onevent="cerrarModalSiExito"/>
                                        </h:commandButton>
                                    </div>
                                </h:form>
                            </div>
                        </div>
                    </div>
                </h:panelGroup>

                <script>
                    var myModal;
                    function abrirModal(data) {
                        if (data.status === 'success') {
                            var el = document.getElementById('modalUsuario');
                            myModal = new bootstrap.Modal(el);
                            myModal.show();
                        }
                    }
                    function cerrarModalSiExito(data) {
                        if (data.status === 'success') {
                            var el = document.getElementById('modalUsuario');
                            var modalInstance = bootstrap.Modal.getInstance(el);
                            if (modalInstance) modalInstance.hide();
                            document.querySelectorAll('.modal-backdrop').forEach(e => e.remove());
                        }
                    }
                </script>

            </ui:define>
        </ui:composition>
    </body>
</html>