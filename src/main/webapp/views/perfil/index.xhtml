<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core">

    <body>

        <ui:composition template="./../TemplateSitio.xhtml">

            <ui:define name="top">
                
            </ui:define>

            <ui:define name="left">
                
            </ui:define>

            <ui:define name="content">
                <div class="container mt-4 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <i class="fa fa-user-circle fa-2x"></i>
                    <h4>Perfil del Usuario</h4>
                </div>

                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-4 font-weight-bold">Nombre:</div>
                        <div class="col-sm-8">#{login.nombreUsuario}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 font-weight-bold">Documento:</div>
                        <div class="col-sm-8">#{login.NUMERO_DOCUMENTO}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 font-weight-bold">Rol:</div>
                        <div class="col-sm-8">#{login.rolActual}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 font-weight-bold">Correo:</div>
                        <div class="col-sm-8"></div>
                    </div>

                    <!-- Bot√≥n para cerrar sesi√≥n o editar perfil -->
                    <div class="text-center mt-4">
                        <h:form><h:commandButton value="Editar Perfil" 
                                          
                                         styleClass="btn btn-outline-primary btn-sm" 
                                         rendered="#{permisos.descripcion eq 'dashboard'}"/></h:form>
                    </div>
                </div>
            </div>
        </div>
                
                <div class="profile-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="display: flex; gap: 20px; align-items: center;">
                        <h:graphicImage value="#{empty perfilBean.usuario.fotoPerfil ? '/resources/images/default-avatar.png' : perfilBean.usuario.fotoPerfil}"
                                        style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid #ddd; object-fit: cover;" />

                        <div>
                            <h1 style="margin: 0;">#{perfilBean.usuario.primerNombre} #{perfilBean.usuario.primerApellido}</h1>
                            <h:outputText value="#{perfilBean.usuario.correoUsuario}" style="color: gray;" /> <br/>
                            <span class="badge badge-primary">#{perfilBean.usuario.rolIdRol.nombreRol}</span>
                        </div>
                    </div>

                    <div class="actions">
                        <h:button value="‚úé Editar Perfil" outcome="perfilEditar" styleClass="btn btn-outline" />
                        <h:button value="üõ°Ô∏è Seguridad" outcome="cambiarPassword" styleClass="btn btn-outline" style="margin-left: 10px;" />
                    </div>
                </div>

                <div style="margin-top:8px;">
                    <h:form id="uploadForm" enctype="multipart/form-data">
                        <div style="display:flex; gap:8px; align-items:center;">
                            <h:inputFile value="#{perfilBean.uploadedPhoto}" />
                            <h:commandButton value="Subir foto" action="#{perfilBean.subirFoto}" styleClass="btn btn-primary btn-sm" />
                        </div>
                    </h:form>
                </div>

                <h:panelGrid columns="2" columnClasses="col-top, col-top" style="width: 100%; gap: 20px;">
                    
                    <h:panelGroup layout="block" styleClass="card">
                        <div class="card-header">
                            <h3>Informaci√≥n Personal</h3>
                            <p>Datos b√°sicos y de contacto</p>
                        </div>
                        <div class="card-body">
                            <h:panelGrid columns="2" styleClass="info-table" cellpadding="5">
                                <h:outputLabel value="Documento:" style="font-weight: bold;" />
                                <h:outputText value="#{perfilBean.usuario.dni}" />

                                <h:outputLabel value="Tel√©fono:" style="font-weight: bold;" />
                                <h:outputText value="#{perfilBean.usuario.telefono}" />

                                <h:outputLabel value="Estado:" style="font-weight: bold;" />
                                <h:outputText value="#{perfilBean.usuario.estado}" 
                                              style="color: #{perfilBean.usuario.estado == 'activo' ? 'green' : 'red'}" />
                                              
                                <h:outputLabel value="√öltimo Acceso:" style="font-weight: bold;" />
                                <h:outputText value="#{perfilBean.usuario.ultimo_acceso_at}">
                                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm" />
                                </h:outputText>
                            </h:panelGrid>
                        </div>
                    </h:panelGroup>

                    <h:panelGroup layout="block" styleClass="card">
                        <div class="card-header">
                            <h3>Actividad Reciente</h3>
                            <p>√öltimas acciones en el sistema</p>
                        </div>
                        <div class="card-body">
                            <h:form id="actividadForm">
                                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                                    <h:outputLabel value="Desde:" />
                                    <h:inputText value="#{perfilBean.filterFrom}"><f:convertDateTime pattern="yyyy-MM-dd"/></h:inputText>
                                    <h:outputLabel value="Hasta:" />
                                    <h:inputText value="#{perfilBean.filterTo}"><f:convertDateTime pattern="yyyy-MM-dd"/></h:inputText>
                                    <h:commandButton value="Filtrar" action="#{perfilBean.filtrarActividades}" styleClass="btn btn-outline-primary btn-sm" />
                                    <h:commandButton value="Limpiar" action="#{perfilBean.cargarActividades}" styleClass="btn btn-outline-secondary btn-sm" />
                                </div>
                            </h:form>

                            <ui:repeat value="#{perfilBean.actividadesFiltradas}" var="act">
                                <div style="margin-bottom:10px; border-left:3px solid #eee; padding-left:10px;">
                                    <strong>Tipo:</strong> #{act.operationType} ‚Äî <small style="color:gray;">#{act.changedAt}</small>
                                    <div style="color: #444;">Recurso: #{act.newExpedienteId}</div>
                                </div>
                            </ui:repeat>

                        </div>
                    </h:panelGroup>

                </h:panelGrid>

            </ui:define>

        </ui:composition>

    </body>
</html>
